# Fase 4 - Transforma√ß√£o e Orquestra√ß√£o de Pipelines üé¨

## SQL para Engenharia de Dados üíæ

O **SQL (Structured Query Language)** √© a linguagem fundamental para manipula√ß√£o e transforma√ß√£o de dados em engenharia de dados. Apesar do surgimento de tecnologias modernas como Apache Spark e bancos NoSQL, o SQL continua sendo indispens√°vel devido √† sua sintaxe declarativa e ado√ß√£o universal.

Nesta etapa, voc√™ aprender√° como o SQL √© utilizado em pipelines de dados modernos, suas funcionalidades avan√ßadas e por que ele √© essencial para a transforma√ß√£o de dados antes de avan√ßarmos para o **DBT (Data Build Tool)**, que √© uma ferramenta de transforma√ß√£o baseada inteiramente em SQL. üõ†Ô∏è

### Por que SQL √© crucial para Engenharia de Dados? üéØ

#### 1. Extra√ß√£o de Dados
O SQL facilita a extra√ß√£o de dados de fontes estruturadas como bancos relacionais (PostgreSQL, MySQL, Oracle) e sistemas semi-estruturados que suportam consultas SQL (Google BigQuery, AWS Redshift, Snowflake).

#### 2. Transforma√ß√£o de Dados
Engenheiros de dados utilizam SQL para realizar tarefas de limpeza, agrega√ß√£o e normaliza√ß√£o. T√©cnicas como **CTEs (Common Table Expressions)**, **fun√ß√µes de janela (Window Functions)** e **subconsultas** simplificam transforma√ß√µes complexas.

#### 3. Carregamento de Dados
Pipelines baseados em SQL frequentemente carregam dados em data warehouses ou data lakes, garantindo armazenamento eficiente e integra√ß√£o com ferramentas de Business Intelligence.

#### 4. Integra√ß√£o de Dados
SQL permite que engenheiros fa√ßam join de datasets diversos, criando modelos de dados unificados que suportam an√°lises abrangentes.

#### 5. Otimiza√ß√£o de Performance
Mecanismos SQL (Apache Hive, Presto, Spark SQL) fornecem recursos de otimiza√ß√£o de queries que melhoram a efici√™ncia dos pipelines, reduzindo tempo de execu√ß√£o e consumo de recursos.

### SQL para ETL vs. ELT

| **Aspecto** | **ETL (Extract, Transform, Load)** | **ELT (Extract, Load, Transform)** |
|-------------|-----------------------------------|-----------------------------------|
| Transforma√ß√£o | Realizada antes do carregamento | Realizada ap√≥s o carregamento |
| Processamento | Orientado a batch | Suporta batch e tempo real |
| Ferramentas | SQL + Python, SSIS | SQL (BigQuery, Redshift, Snowflake) |
| Escalabilidade | Moderada | Altamente escal√°vel |
| Casos de Uso | Sistemas legados, ambientes on-premise | Plataformas de dados em nuvem |

O SQL desempenha papel central em ambos os paradigmas, mas o ELT √© cada vez mais favorecido devido √† escalabilidade da computa√ß√£o em nuvem e capacidades de processamento paralelo.

### SQL Essencial para Engenheiros de Dados üìö

#### 1. Window Functions (Fun√ß√µes de Janela)
**O que √©**: Fun√ß√µes que fazem c√°lculos em grupos de linhas (janelas) sem agrupar/resumir os dados, mantendo todas as linhas originais na sa√≠da.

**Por que usar**: Permite calcular coisas como "soma acumulada", "ranks", "m√©dias m√≥veis" mantendo o n√≠vel de detalhe original. Diferente de `GROUP BY`, que colapsa as linhas.

**Exemplo**:
```sql
SELECT 
    customer_id, 
    order_date, 
    SUM(order_amount) OVER (
        PARTITION BY customer_id 
        ORDER BY order_date
    ) AS cumulative_sales
FROM orders;
```
Este exemplo calcula a soma acumulada de compras por cliente ao longo do tempo, linha por linha.

#### 2. Common Table Expressions (CTEs)
**O que √©**: Uma forma de criar "tabelas tempor√°rias" dentro de uma query usando a cl√°usula `WITH`. √â como criar vari√°veis no SQL.

**Por que usar**: Torna queries complexas mais leg√≠veis e organizadas, quebrando em partes menores e reutiliz√°veis. Tamb√©m permite consultas recursivas (√∫teis para hierarquias).

**Exemplo**:
```sql
WITH recent_orders AS (
    SELECT order_id, customer_id, order_date
    FROM orders
    WHERE order_date > '2026-01-01'
)
SELECT * FROM recent_orders;
```
Aqui criamos uma "tabela tempor√°ria" chamada `recent_orders` e depois usamos ela como se fosse uma tabela real.

#### 3. Joins
**O que √©**: Forma de combinar dados de m√∫ltiplas tabelas relacionadas em uma √∫nica consulta, baseado em colunas comuns.

**Por que usar**: Na pr√°tica, os dados est√£o espalhados em v√°rias tabelas (ex: clientes em uma tabela, pedidos em outra). Joins permitem reunir essas informa√ß√µes para an√°lises completas.

**Tipos comuns**:
- `INNER JOIN`: Retorna apenas registros que existem em ambas as tabelas
- `LEFT JOIN`: Retorna todos da tabela √† esquerda + correspondentes da direita
- `RIGHT JOIN`: O contr√°rio do LEFT JOIN

**Exemplo**:
```sql
SELECT customers.name, orders.order_id
FROM customers
JOIN orders ON customers.customer_id = orders.customer_id;
```
Aqui combinamos dados de clientes com seus pedidos, usando o ID do cliente como chave de liga√ß√£o.

#### 4. Qualify Clause
**O que √©**: Uma forma simples de filtrar resultados de window functions diretamente, sem precisar usar CTEs ou subconsultas.

**Por que usar**: Antes, para filtrar ap√≥s usar window functions, voc√™ precisava fazer subquery ou CTE. Com `QUALIFY`, voc√™ filtra direto na query principal, deixando o c√≥digo mais limpo.

**Exemplo**:
```sql
SELECT customer_id, order_date, order_amount,
       ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY order_date DESC) as rn
FROM orders
QUALIFY rn = 1;  -- Pega apenas a √∫ltima ordem de cada cliente
```
Este exemplo pega apenas a ordem mais recente de cada cliente, sem precisar de subquery.

#### 5. GROUP BY ALL
**O que √©**: Um atalho que agrupa automaticamente por todas as colunas que n√£o s√£o fun√ß√µes agregadas (SUM, COUNT, AVG, etc).

**Por que usar**: Evita ter que listar manualmente todas as colunas no `GROUP BY`. √ötil quando voc√™ tem muitas colunas e quer evitar repeti√ß√£o.

**Importante**: Nem todos os bancos suportam (BigQuery e alguns outros sim).

**Exemplo**:
```sql
SELECT 
    region, 
    product_category, 
    SUM(sales) as total_sales
FROM sales_data
GROUP BY ALL;  -- Agrupa automaticamente por region e product_category
```
Ao inv√©s de escrever `GROUP BY region, product_category`, o `GROUP BY ALL` faz isso automaticamente.

#### 6. COUNT_IF
**O que √©**: Uma fun√ß√£o agregada que conta apenas linhas que atendem a uma condi√ß√£o espec√≠fica, sem precisar usar `COUNT(CASE WHEN ...)`.

**Por que usar**: Simplifica contagens condicionais. Antes voc√™ precisava escrever `COUNT(CASE WHEN condi√ß√£o THEN 1 END)`, agora √© s√≥ `COUNT_IF(condi√ß√£o)`.

**Exemplo**:
```sql
SELECT 
    product_id,
    COUNT(*) as total_orders,
    COUNT_IF(order_status = 'completed') as completed_orders
FROM orders
GROUP BY product_id;
```
Aqui contamos o total de pedidos e separadamente quantos foram completados, de forma mais simples.

### SQL em Ferramentas Modernas de Engenharia de Dados üîß

| **Ferramenta** | **Prop√≥sito** | **Papel do SQL** |
|----------------|---------------|------------------|
| Apache Hive | Data Warehousing no Hadoop | HiveQL para consultar dados no HDFS |
| Apache Spark SQL | Processamento distribu√≠do em larga escala | Queries SQL em DataFrames |
| Google BigQuery | Data warehouse serverless | SQL padr√£o para analytics |
| AWS Redshift | Data warehouse em nuvem | SQL similar ao PostgreSQL |
| Snowflake | Plataforma de dados em nuvem | ANSI SQL para dados estruturados |
| dbt (Data Build Tool) | Transforma√ß√£o de dados | Transforma√ß√µes baseadas em SQL |

### Boas Pr√°ticas para Escrever SQL em Engenharia de Dados ‚ú®

1. **Use CTEs para Queries Complexas**: Divida queries em blocos leg√≠veis, reduzindo overhead de manuten√ß√£o.
2. **Evite SELECT \***: Especifique colunas necess√°rias para melhorar performance e minimizar transfer√™ncia de dados.
3. **Aproveite √çndices e Particionamento**: Otimize datasets grandes usando √≠ndices, parti√ß√µes e chaves de clustering em plataformas como BigQuery e Redshift.
4. **Monitore Performance de Queries**: Use planos EXPLAIN e analisadores de query para entender gargalos e otimizar queries.
5. **Siga Padr√µes de Governan√ßa de Dados**: Garanta conformidade com pol√≠ticas organizacionais de dados, incluindo privacidade e protocolos de seguran√ßa.

### Materiais de Aprendizado üìñ

Abaixo, voc√™ encontra materiais essenciais sobre SQL para engenharia de dados:

#### Artigos e Tutoriais:
- [üìù SQL for Data Engineering to Build Scalable Data Pipelines](https://www.integrate.io/blog/sql-for-data-engineering/) - Guia completo sobre SQL em pipelines de dados
- [üìö 25 SQL tips to level up your data engineering skills](https://www.startdataengineering.com/post/n-sql-tips-de/) - Dicas pr√°ticas e avan√ßadas de SQL

#### V√≠deos:
- [üé• Playlist: SQL para Engenharia de Dados](https://www.youtube.com/playlist?list=PL5TJqBvpXQv5n1N15kcK1m9oKJm_cv-m6) - Conte√∫do em v√≠deo sobre SQL

### O Futuro do SQL em Engenharia de Dados üöÄ

Apesar do surgimento de NoSQL e computa√ß√£o distribu√≠da, a natureza declarativa do SQL e sua adaptabilidade garantem sua relev√¢ncia no cen√°rio de engenharia de dados. O surgimento de abstra√ß√µes baseadas em SQL como dbt e extens√µes SQL para big data (SparkSQL, Trino) sinalizam a evolu√ß√£o do SQL junto com arquiteturas modernas de dados.

**Tend√™ncias Principais**:
- **SQL em Dados Streaming**: Analytics em tempo real usando plataformas como Apache Flink e ksqlDB
- **Queries Federadas**: Acesso a dados cross-platform usando SQL (ex: tabelas externas do BigQuery)
- **SQL & Data Mesh**: Propriedade descentralizada de dados com SQL servindo como camada comum de consulta

### Pr√≥ximos Passos üéØ

Agora que voc√™ compreendeu os fundamentos e conceitos avan√ßados de SQL, est√° pronto para aplicar esse conhecimento no **DBT (Data Build Tool)**, uma ferramenta que utiliza SQL como base para transforma√ß√µes de dados de forma modular, test√°vel e version√°vel.

### Vamos colocar a m√£o na massa? üí™
